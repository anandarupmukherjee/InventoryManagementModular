{% load static %}
{% load inventory_extras %}
{% load feature_flags %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Track & Complete Purchase Orders</title>
  <link rel="stylesheet" href="{% static 'inventory/styles.css' %}">
  <script src="{% static 'inventory/po_completion.js' %}" defer></script>
</head>
<body>

  
    <!-- Navigation Bar -->
    {% include "includes/navbar.html" %}


  <div class="dashboard-container form-v2 two-col w-75 gap-5p">
    
    <!-- Purchase Orders Table -->
    <div class="col col-2">
    <div class="card table-card">
      <h2>Purchase Orders</h2>
      <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Product Code</th>
            <th>PO Ref</th>
            <th>Quantity</th>
            <th>Order Date</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for order in purchase_orders %}
            <tr class="po-row {% if order.status == 'Delayed' %}delayed-row{% endif %}"
              data-product-code="{{ order.product_code }}"
              data-product-name="{{ order.product_name }}"
              data-quantity="{{ order.quantity_ordered }}"
              data-po-ref="{{ order.po_reference|default:'' }}"
              data-expected="{{ order.expected_delivery|date:'Y-m-d\\TH:i' }}"
              data-delivered-at="{% if order.status == 'Delivered' %}{{ order.delivered_at|date:'c' }}{% endif %}"
            >
              <td>{{ order.product_name }}</td>
              <td>{{ order.product_code }}</td>
              <td>{% if order.po_reference %}{{ order.po_reference }}{% else %}—{% endif %}</td>
              <td>{{ order.quantity_ordered }}</td>
              <td>{{ order.order_date|date:'Y-m-d H:i' }}</td>
              <td>
                {% if order.status == "Delayed" %}
                  <span class="status-delayed">⚠️ Delayed</span>
                {% elif order.status == "Delivered" %}
                  <span class="status-delivered">✅ Delivered</span>
                {% else %}
                  {{ order.status }}
                {% endif %}
              </td>
              <td>
                {% if order.status != "Delivered" %}
                <button type="button" class="btn btn-primary fill-form-btn"
                        data-product-code="{{ order.product_code }}"
                        data-product-name="{{ order.product_name }}"
                        data-quantity="{{ order.quantity_ordered }}"
                        data-po-ref="{{ order.po_reference|default:'' }}"
                        data-expected="{{ order.expected_delivery|date:'Y-m-d\\TH:i' }}">
                  Complete
                </button>
                {% else %}
                  <span class="text-muted">Complete</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6">No purchase orders placed yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
    </div>

    <!-- Complete PO Form -->
<div class="col col-1">
<div class="card form-card">
  <h2>Complete Purchase Order</h2>
  <!-- Completion Submission Form -->
  <div class="form-body">
  <form method="post" id="po-completion-form" class="form-v2-form">
    {% csrf_token %}
    {{ completion_form.non_field_errors }}


    <fieldset>
      <legend>Product Info</legend>

      <div class="mb-2">
        <label for="id_po_reference">PO Reference</label>
        {{ completion_form.po_reference|add_class:"form-control" }}
      </div>
      <div class="mb-2">
        {{ completion_form.product_code.label_tag }}
        {{ completion_form.product_code|add_class:"form-control" }}
      </div>
      <div class="mb-2">
        {{ completion_form.product_name.label_tag }}
        {{ completion_form.product_name|add_class:"form-control" }}
      </div>
      <!-- Lot mode toggle -->
      <div class="radio-group inline mb-2">
        <label class="radio-pill"><input type="radio" name="lot_mode" value="single" checked> Single lot</label>
        <label class="radio-pill"><input type="radio" name="lot_mode" value="multiple"> Multiple lots</label>
      </div>

      <!-- Single lot section -->
      <div id="single-lot-section">
        <div class="mb-2">
          {{ completion_form.lot_number.label_tag }}
          {{ completion_form.lot_number|add_class:"form-control" }}
        </div>
        <div class="mb-2">
          {{ completion_form.expiry_date.label_tag }}
          {{ completion_form.expiry_date|add_class:"form-control" }}
        </div>
      </div>

      <!-- Multiple lots section -->
      <div id="multi-lot-section" style="display:none;">
        <div class="mb-2" style="font-size: 0.9em; color: #333;">
          Ordered Qty: <strong id="ordered_qty_hint">0</strong>
          · Total received across lots: <strong id="multi_total_qty">0</strong>
          <span id="multi_qty_warning" style="margin-left: 6px;"></span>
        </div>
        <div class="mb-2">
          <button type="button" id="add_lot_row" class="btn btn-secondary btn-small">Add Row</button>
        </div>
        <div id="lots_container"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Delivery Info</legend>

      <div class="mb-2" id="single-qty-wrap">
        {{ completion_form.quantity_ordered.label_tag }}
        {{ completion_form.quantity_ordered|add_class:"form-control" }}
      </div>
      <!-- <div class="mb-2">
        {{ completion_form.expected_delivery.label_tag }}
        {{ completion_form.expected_delivery|add_class:"form-control" }}
      </div> -->
      <div class="mb-2">
        {{ completion_form.status.label_tag }}
        {{ completion_form.status|add_class:"form-control" }}
      </div>
    </fieldset>
    <!-- <input type="hidden" name="status" value="Delivered"> -->


    <div class="form-actions-sticky">
      <button type="submit" class="btn btn-success mt-3">Mark as Delivered</button>
      <a href="{% url 'inventory:track_purchase_orders' %}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
  </div>
</div>
</div>

  </div>
</body>
</html>
