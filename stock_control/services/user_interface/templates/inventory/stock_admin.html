{% load static %}
{% load feature_flags %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Admin</title>
  <link rel="stylesheet" type="text/css" href="{% static 'inventory/styles.css' %}">

  <script src="{% static 'inventory/barcode_fetch.js' %}"></script>
  <script src="{% static 'inventory/barcode_parser.js' %}"></script>
  <script src="{% static 'inventory/table_search.js' %}"></script>

  <style>
  .badge { padding: 2px 6px; border-radius: 10px; font-size: 12px }
  .badge-grey { background:#e5e7eb; color:#111827 }
  .badge-red { background:#fee2e2; color:#991b1b }
  .badge-green { background:#dcfce7; color:#065f46 }
</style>


  <style>
    .expired-row {
      background-color: #ffd6d6;
      animation: blinkFade 1s ease-in-out infinite;
    }

    @keyframes blinkFade {
      0%, 100% { background-color: #ffd6d6; }
      50% { background-color: #ffffff; }
    }

    .delete-button {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .delete-button:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  {% include "includes/navbar.html" %}

  <div class="dashboard-container">
    {% now "Y-m-d" as today_str %}


    <!-- ‚úÖ Flex wrapper for horizontal layout -->
    <div class="table-card-wrapper">


      <!-- Product + Lot Form -->
      <div class="card form-card narrow-card">
        <h2>{% if editing_product %}Edit Product: {{ editing_product.name }}{% else %}Add New Product{% endif %}</h2>

        <form method="get" action="{% url 'data_collection_1:stock_admin' %}">
          <label for="id_barcode_scan">Scan or Enter Barcode:</label>
          <input type="text" name="raw" id="id_barcode_scan" placeholder="Scan barcode here" autofocus>
          <button type="submit">Fetch Product</button>
        </form>

        <form method="POST">
          {% csrf_token %}
          <fieldset>
            <legend>Product Details</legend>
            {{ product_form.as_p }}
          </fieldset>
          <fieldset>
            <legend>Lot Information</legend>
            {{ product_item_form.as_p }}
          </fieldset>
          <button type="submit">
            {% if editing_product %}Save Changes{% else %}Add Product and Lot{% endif %}
          </button>
        </form>

        {% if editing_product %}
          <p><a href="{% url 'data_collection_1:stock_admin' %}">Create a new product instead</a></p>
        {% endif %}
      </div>

      <!-- Product Lots Table -->
      <div class="card table-card wide-card">
        <h2>Product Lots & Expired Lots</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Action</th>
                <th>Product</th>
                <th>Lot Number</th>
                <th>Received</th> 
                <th>Expiry</th>
                <th>Stock</th>
                <th>Units/Item</th>
                <th>Partial Units</th>
                <th>Type</th>
                <th>Acceptance</th>    
                <th>Test Ref</th>          
                <th>Signed Off</th>        
                <th>QA</th> 
              </tr>
            </thead>
            <tbody>
              {% for p in products %}
                {% for item in p.items.all %}
                  {% with item_date=item.expiry_date|date:"Y-m-d" %}
                    {% if item.expiry_date and item_date <= today_str %}
                      <tr class="expired-row">
                    {% else %}
                      <tr>
                    {% endif %}
                  {% endwith %}

                    {# Delete button for expired lots (unchanged) #}
                    {% with item_date=item.expiry_date|date:"Y-m-d" %}
                      {% if item.expiry_date and item_date <= today_str %}
                        <td>
                          <form method="POST" action="{% url 'data_collection_1:delete_lot' item.id %}" onsubmit="return confirm('Are you sure you want to discard this expired lot?');">
                            {% csrf_token %}
                            <button type="submit" class="delete-button">üóëÔ∏è Delete Lot</button>
                          </form>
                        </td>
                      {% else %}
                        <td></td>
                      {% endif %}
                    {% endwith %}

                    <td>{{ p.name }}</td>
                    <td>{{ item.lot_number }}</td>
                    <td>
                      {% if item.received_at %}{{ item.received_at|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}
                    </td>
                    <td>{{ item.expiry_date|date:"Y-m-d" }}</td>
                    <td>{{ item.current_stock }}</td>
                    <td>{{ item.units_per_quantity }}</td>
                    <td>{{ item.accumulated_partial }}</td>
                    <td>{{ item.product_feature }}</td>

                    {# --- Acceptance section (NEW) --- #}
                    {% with lat=item.acceptance_tests.last %}
                      <td>
                        {% if lat %}
                          {% if lat.passed %}
                            <span class="badge badge-green">Passed</span>
                          {% elif lat.tested %}
                            <span class="badge badge-red">Failed</span>
                          {% else %}
                            <span class="badge badge-grey">Not tested</span>
                          {% endif %}
                        {% else %}
                          <span class="badge badge-grey">Not tested</span>
                        {% endif %}
                      </td>
                      <td>{% if lat and lat.test_reference %}{{ lat.test_reference }}{% else %}‚Äî{% endif %}</td>
                      <td>
                        {% if lat and lat.signed_off_by %}
                          {{ lat.signed_off_by }}
                          {% if lat.signed_off_at %}<br><small>{{ lat.signed_off_at|date:"Y-m-d H:i" }}</small>{% endif %}
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </td>
                    {% endwith %}

                    <td>
                      <a href="{% url 'data_collection_3:create-acceptance-test' item_id=item.id %}">Add/Update</a>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>

          </table>
        </div>
      </div>

    </div> <!-- /.table-card-wrapper -->

  </div> <!-- /.dashboard-container -->

</body>
</html>
