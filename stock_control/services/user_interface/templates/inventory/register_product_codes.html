{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register Product Codes</title>
    <link rel="stylesheet" type="text/css" href="{% static 'inventory/styles.css' %}">
</head>
<body>
    {% include "includes/navbar.html" %}

    <div class="page-container register-product-codes form-v2">
        <div class="card form-card">
            <h1>Register Product Codes</h1>
            <p class="subtitle">Link new or legacy product codes and barcodes to the catalogue for easier scanning.</p>

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message {{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if form.non_field_errors %}
                <div class="form-errors">
                    {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <form method="post" class="mapping-form">
                {% csrf_token %}
                {% if editing_mapping %}
                    <input type="hidden" name="mapping_id" value="{{ editing_mapping.id }}">
                    <div class="form-editing-banner">
                        Editing mapping #{{ editing_mapping.id }}. <a href="{% url 'data_collection_4:register-product-codes' %}">Cancel edit</a>
                    </div>
                {% endif %}

                <div class="form-group mode-toggle">
                    {{ form.mode.label_tag }}
                    <div class="radio-group">
                        {{ form.mode }}
                    </div>
                    {% for error in form.mode.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    <p class="field-note">Choose whether you are linking codes to an existing product or adding a brand new one.</p>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        {{ form.barcode.label_tag }}
                        {{ form.barcode }}
                        {% for error in form.barcode.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                        <p class="field-note">Scan first—product code auto-fills from GS1, 3PR, or raw barcode data.</p>
                    </div>
                    <div class="form-group">
                        {{ form.new_product_code.label_tag }}
                        {{ form.new_product_code }}
                        {% for error in form.new_product_code.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                        <p class="field-note">Auto-populated from the barcode. Adjust only if needed.</p>
                    </div>
                    <div class="form-group" data-mode-section="existing">
                        {{ form.product.label_tag }}
                        {{ form.product }}
                        {% for error in form.product.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="form-group" data-mode-section="existing">
                        {{ form.old_product_code.label_tag }}
                        {{ form.old_product_code }}
                        {% for error in form.old_product_code.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="form-group">
                        {{ form.notes.label_tag }}
                        {{ form.notes }}
                        {% for error in form.notes.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="form-group" data-mode-section="new_product">
                        {{ form.new_product_name.label_tag }}
                        {{ form.new_product_name }}
                        {% for error in form.new_product_name.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="form-group" data-mode-section="new_product">
                        {{ form.new_product_supplier.label_tag }}
                        {{ form.new_product_supplier }}
                        {% for error in form.new_product_supplier.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                    </div>
                    <div class="form-group" data-mode-section="new_product">
                        {{ form.new_product_threshold.label_tag }}
                        {{ form.new_product_threshold }}
                        {% for error in form.new_product_threshold.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                        <p class="field-note">Alerts trigger when stock reaches this number. Leave 0 if undecided.</p>
                    </div>
                    <div class="form-group" data-mode-section="new_product">
                        {{ form.new_product_lead_time_days.label_tag }}
                        {{ form.new_product_lead_time_days }}
                        {% for error in form.new_product_lead_time_days.errors %}<span class="field-error">{{ error }}</span>{% endfor %}
                        <p class="field-note">Days needed between ordering and delivery.</p>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">{% if editing_mapping %}Update Mapping{% else %}Save Mapping{% endif %}</button>
                    {% if editing_mapping %}
                        <a class="btn-secondary" href="{% url 'data_collection_4:register-product-codes' %}">Cancel</a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="card table-card">
            <div class="table-card-header">
                <h2>Existing Mappings</h2>
                <form method="get" class="search-form">
                    <input type="search" name="q" value="{{ search_term }}" placeholder="Search by product, code, or barcode">
                    <button type="submit">Search</button>
                </form>
            </div>

            {% if mappings %}
                <div class="table-wrapper scrollable">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>New Code</th>
                                <th>Old Code</th>
                                <th>Barcode</th>
                                <th>Notes</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mapping in mappings %}
                                <tr>
                                    <td>{% if mapping.product %}{{ mapping.product.name }}{% else %}—{% endif %}</td>
                                    <td>{{ mapping.new_product_code|default:"—" }}</td>
                                    <td>{{ mapping.old_product_code|default:"—" }}</td>
                                    <td><span class="mono">{{ mapping.barcode|default:"—" }}</span></td>
                                    <td>{{ mapping.notes|default:"" }}</td>
                                    <td>{{ mapping.updated_at|date:"Y-m-d H:i" }}</td>
                                    <td class="actions">
                                        <a class="btn-secondary btn-small" href="{% url 'data_collection_4:register-product-codes' %}?edit={{ mapping.id }}{% if search_term %}&amp;q={{ search_term|urlencode }}{% endif %}">Edit</a>
                                        <form method="post" class="inline-form" style="display:inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_id" value="{{ mapping.id }}">
                                            <button type="submit" class="btn-danger btn-small" onclick="return confirm('Delete this mapping?');">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="empty-state">No mappings recorded yet. Add your first mapping above.</p>
            {% endif %}
        </div>
    </div>

    <script>
        (function () {
            const form = document.querySelector('.mapping-form');
            if (!form) return;

            const modeInputs = form.querySelectorAll('input[name="mode"]');
            const conditionalSections = form.querySelectorAll('[data-mode-section]');
            const productSelect = form.querySelector('select[name="product"]');

            const applyMode = () => {
                const selected = form.querySelector('input[name="mode"]:checked');
                const mode = selected ? selected.value : null;

                conditionalSections.forEach(section => {
                    const targetMode = section.getAttribute('data-mode-section');
                    section.hidden = mode !== targetMode;
                });

                if (productSelect) {
                    productSelect.disabled = mode !== 'existing';
                }
            };

            modeInputs.forEach(input => {
                input.addEventListener('change', applyMode);
            });

            applyMode();
        })();
    </script>
</body>
</html>
